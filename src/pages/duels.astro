---
export const prerender = false;

import Layout from "@/layouts/HTML.astro";

const { cookies, redirect } = Astro;

const accessToken = cookies.get("sb-access-token");
const refreshToken = cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
    return redirect("/login");
}
---

<Layout title="Join Queue">
    <div class="w-full max-w-md bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 sm:p-8">
        <div class="mb-6 text-center">
            <h1 class="text-2xl font-bold">Join Queue</h1>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
                Waiting for an opponent in your favorite game? Join the queue and get matched!
            </p>
        </div>
        <form action="/api/duel/queue/join" method="post" class="space-y-6">
            <div>
                <label for="game_id" class="block text-sm font-medium">Select Game</label>
                <select
                    name="game_id"
                    id="game_id"
                    required
                    class="w-full px-4 py-2 mt-1 border rounded-lg bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500 text-gray-900 dark:text-gray-100"
                >
                    <option value="10">Chess</option>
                    <option value="11">Checkers</option>
                    <option value="12">Poker</option>
                </select>
            </div>
            <button
                type="submit"
                class="w-full py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-100 dark:focus:ring-offset-gray-900"
            >
                Join Queue
            </button>
        </form>

        <!-- Matchmaking Button -->
        <button
            id="matchmake"
            class="w-full mt-4 py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-md focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-gray-100 dark:focus:ring-offset-gray-900"
        >
            Find Opponent
        </button>
    </div>
</Layout>

<script>
    async function pollForDuelStatus() {
        const interval = setInterval(async () => {
            try {
                const response = await fetch("/api/duel/status");
                if (response.ok) {
                    const { duel } = await response.json();
                    alert(`Duel found! Opponent ID: ${duel.player_2}`);
                    clearInterval(interval); // Stop polling once a duel is found
                    window.location.href = `/duel/${duel.id}`; // Redirect to the duel page
                }
            } catch (error) {
                console.error("Error checking duel status:", error);
            }
        }, 5000); // Poll every 5 seconds
    }

    pollForDuelStatus();

    document.getElementById("matchmake")?.addEventListener("click", async () => {
        try {
            const response = await fetch("/api/duel/queue/match", { method: "POST" });
            const result = await response.json();
            alert(result.message);
        } catch (error) {
            console.error("Error initiating matchmaking:", error);
        }
    });
</script>
